<!DOCTYPE html>
<html>
    <head>
        <script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
        <script src="https://www.google.com/jsapi"></script>
    </head>
    <style>
     body {
         font-family: "Helvetica Neue", Helvetica, sans-serif;
         margin: 0 auto 4em auto;
         tab-size: 2;
         -webkit-text-size-adjust: none;
     }
     .axis path,
     .axis line {
         fill: none;
         stroke: #000;
         shape-rendering: crispEdges;}
     .x.axis path {display: none;}
     .line {
         fill: none;
         stroke: steelblue;
         stroke-width: 1.5px;}
     .area {
         fill: lightblue;
         clip-path: url(#clip);}
     .spike {fill: green;}
     .drop {fill: red;}
     .column {
         max-width: 960px;
         position: relative;
         display: block;
         margin: 0 auto;
         padding: 0 10px;
     }
     #twit_link {
         margin-right: 15px;
     }
     .research_links {
         display: inline;
         margin-left: 25%;
     }
     .sub_section {
         border: solid 1px #eee;
         border-bottom: solid 1px #ccc;
         margin-top: 25px;
     }
     .link_boxes {
         display: inline-block;
     }
     .notice {
         margin:auto;
         display:table;
     }
     .bigbooty {padding-bottom: 25px;}
    </style>

    <body>
        <div class="column">
            <h1> Tor Anomaly Detection</h1>
            <h4>Rewrite & Demo Visualization</h4>
            <select id = "country_picker"> </select>
            <p>Select a country from the drop down to get started.</p>
            <div id="anomaly_info" class="sub_section">
                <div id="content_date" class="notice"></div>
                <div class="research_links">
                    <div id="twit_link" class="link_boxes"></div>
                    <div id="goo_link" class="link_boxes"></div>
                </div>
                <div class="notice bigbooty">
                    <strong > Click on a green or red dot in a graph to get links to possible censorship events on that date.</strong>
                </div>
            </div>
            <div id="viz_frame" class="sub_section">
                <script>
                 var isoCountries = {'AF' : 'Afghanistan','AX' : 'Aland Islands','AL' : 'Albania','DZ' : 'Algeria','AS' : 'American Samoa','AD' : 'Andorra','AO' : 'Angola','AI' : 'Anguilla','AQ' : 'Antarctica','AG' : 'Antigua And Barbuda','AR' : 'Argentina','AM' : 'Armenia','AW' : 'Aruba','AU' : 'Australia','AT' : 'Austria','AZ' : 'Azerbaijan','BS' : 'Bahamas','BH' : 'Bahrain','BD' : 'Bangladesh','BB' : 'Barbados','BY' : 'Belarus','BE' : 'Belgium','BZ' : 'Belize','BJ' : 'Benin','BM' : 'Bermuda','BT' : 'Bhutan','BO' : 'Bolivia','BA' : 'Bosnia And Herzegovina','BW' : 'Botswana','BV' : 'Bouvet Island','BR' : 'Brazil','IO' : 'British Indian Ocean Territory','BN' : 'Brunei Darussalam','BG' : 'Bulgaria','BF' : 'Burkina Faso','BI' : 'Burundi','KH' : 'Cambodia','CM' : 'Cameroon','CA' : 'Canada','CV' : 'Cape Verde','KY' : 'Cayman Islands','CF' : 'Central African Republic','TD' : 'Chad','CL' : 'Chile','CN' : 'China','CX' : 'Christmas Island','CC' : 'Cocos (Keeling) Islands','CO' : 'Colombia','KM' : 'Comoros','CG' : 'Congo','CD' : 'Congo, Democratic Republic','CK' : 'Cook Islands','CR' : 'Costa Rica','CI' : 'Cote D\'Ivoire','HR' : 'Croatia','CU' : 'Cuba','CY' : 'Cyprus','CZ' : 'Czech Republic','DK' : 'Denmark','DJ' : 'Djibouti','DM' : 'Dominica','DO' : 'Dominican Republic','EC' : 'Ecuador','EG' : 'Egypt','SV' : 'El Salvador','GQ' : 'Equatorial Guinea','ER' : 'Eritrea','EE' : 'Estonia','ET' : 'Ethiopia','FK' : 'Falkland Islands (Malvinas)','FO' : 'Faroe Islands','FJ' : 'Fiji','FI' : 'Finland','FR' : 'France','GF' : 'French Guiana','PF' : 'French Polynesia','TF' : 'French Southern Territories','GA' : 'Gabon','GM' : 'Gambia','GE' : 'Georgia','DE' : 'Germany','GH' : 'Ghana','GI' : 'Gibraltar','GR' : 'Greece','GL' : 'Greenland','GD' : 'Grenada','GP' : 'Guadeloupe','GU' : 'Guam','GT' : 'Guatemala','GG' : 'Guernsey','GN' : 'Guinea','GW' : 'Guinea-Bissau','GY' : 'Guyana','HT' : 'Haiti','HM' : 'Heard Island & Mcdonald Islands','VA' : 'Holy See (Vatican City State)','HN' : 'Honduras','HK' : 'Hong Kong','HU' : 'Hungary','IS' : 'Iceland','IN' : 'India','ID' : 'Indonesia','IR' : 'Iran, Islamic Republic Of','IQ' : 'Iraq','IE' : 'Ireland','IM' : 'Isle Of Man','IL' : 'Israel','IT' : 'Italy','JM' : 'Jamaica','JP' : 'Japan','JE' : 'Jersey','JO' : 'Jordan','KZ' : 'Kazakhstan','KE' : 'Kenya','KI' : 'Kiribati','KR' : 'Korea','KW' : 'Kuwait','KG' : 'Kyrgyzstan','LA' : 'Lao People\'s Democratic Republic','LV' : 'Latvia','LB' : 'Lebanon','LS' : 'Lesotho','LR' : 'Liberia','LY' : 'Libyan Arab Jamahiriya','LI' : 'Liechtenstein','LT' : 'Lithuania','LU' : 'Luxembourg','MO' : 'Macao','MK' : 'Macedonia','MG' : 'Madagascar','MW' : 'Malawi','MY' : 'Malaysia','MV' : 'Maldives','ML' : 'Mali','MT' : 'Malta','MH' : 'Marshall Islands','MQ' : 'Martinique','MR' : 'Mauritania','MU' : 'Mauritius','YT' : 'Mayotte','MX' : 'Mexico','FM' : 'Micronesia, Federated States Of','MD' : 'Moldova','MC' : 'Monaco','MN' : 'Mongolia','ME' : 'Montenegro','MS' : 'Montserrat','MA' : 'Morocco','MZ' : 'Mozambique','MM' : 'Myanmar','NA' : 'Namibia','NR' : 'Nauru','NP' : 'Nepal','NL' : 'Netherlands','AN' : 'Netherlands Antilles','NC' : 'New Caledonia','NZ' : 'New Zealand','NI' : 'Nicaragua','NE' : 'Niger','NG' : 'Nigeria','NU' : 'Niue','NF' : 'Norfolk Island','MP' : 'Northern Mariana Islands','NO' : 'Norway','OM' : 'Oman','PK' : 'Pakistan','PW' : 'Palau','PS' : 'Palestinian Territory, Occupied','PA' : 'Panama','PG' : 'Papua New Guinea','PY' : 'Paraguay','PE' : 'Peru','PH' : 'Philippines','PN' : 'Pitcairn','PL' : 'Poland','PT' : 'Portugal','PR' : 'Puerto Rico','QA' : 'Qatar','RE' : 'Reunion','RO' : 'Romania','RU' : 'Russian Federation','RW' : 'Rwanda','BL' : 'Saint Barthelemy','SH' : 'Saint Helena','KN' : 'Saint Kitts And Nevis','LC' : 'Saint Lucia','MF' : 'Saint Martin','PM' : 'Saint Pierre And Miquelon','VC' : 'Saint Vincent And Grenadines','WS' : 'Samoa','SM' : 'San Marino','ST' : 'Sao Tome And Principe','SA' : 'Saudi Arabia','SN' : 'Senegal','RS' : 'Serbia','SC' : 'Seychelles','SL' : 'Sierra Leone','SG' : 'Singapore','SK' : 'Slovakia','SI' : 'Slovenia','SB' : 'Solomon Islands','SO' : 'Somalia','ZA' : 'South Africa','GS' : 'South Georgia And Sandwich Isl.','ES' : 'Spain','LK' : 'Sri Lanka','SD' : 'Sudan','SR' : 'Suriname','SJ' : 'Svalbard And Jan Mayen','SZ' : 'Swaziland','SE' : 'Sweden','CH' : 'Switzerland','SY' : 'Syrian Arab Republic','TW' : 'Taiwan','TJ' : 'Tajikistan','TZ' : 'Tanzania','TH' : 'Thailand','TL' : 'Timor-Leste','TG' : 'Togo','TK' : 'Tokelau','TO' : 'Tonga','TT' : 'Trinidad And Tobago','TN' : 'Tunisia','TR' : 'Turkey','TM' : 'Turkmenistan','TC' : 'Turks And Caicos Islands','TV' : 'Tuvalu','UG' : 'Uganda','UA' : 'Ukraine','AE' : 'United Arab Emirates','GB' : 'United Kingdom','US' : 'United States','UM' : 'United States Outlying Islands','UY' : 'Uruguay','UZ' : 'Uzbekistan','VU' : 'Vanuatu','VE' : 'Venezuela','VN' : 'Viet Nam','VG' : 'Virgin Islands, British','VI' : 'Virgin Islands, U.S.','WF' : 'Wallis And Futuna','EH' : 'Western Sahara','YE' : 'Yemen','ZM' : 'Zambia','ZW' : 'Zimbabwe'};


                 function getCountryName (countryCode) {
                     countryCode = countryCode.toUpperCase()
                         if (isoCountries.hasOwnProperty(countryCode)) {
                             return isoCountries[countryCode];
                         } else {
                             return countryCode;
                         }
                 }
                </script>

                <script>
                 var events = {
                     "censor" : ["block", "filter"],
                     "spike" : ["increase", "use", "uptick"]
                 };


                 function create_country_picker() {
                     non_existant_countries_w_data = ['??', 'a1', 'a2']
                     countries_w_data = ['ad', 'ae', 'af', 'ag', 'ai', 'al', 'am', 'an',
                                         'ao', 'ap', 'aq', 'ar', 'as', 'at', 'au', 'aw', 'ax', 'az', 'ba',
                                         'bb', 'bd', 'be', 'bf', 'bg', 'bh', 'bi', 'bj', 'bl', 'bm', 'bn',
                                         'bo', 'bq', 'br', 'bs', 'bt', 'bw', 'by', 'bz', 'ca', 'cd', 'cf',
                                         'cg', 'ch', 'ci', 'ck', 'cl', 'cm', 'cn', 'co', 'cr', 'cs', 'cu',
                                         'cv', 'cw', 'cx', 'cy', 'cz', 'de', 'dj', 'dk', 'dm', 'do', 'dz',
                                         'ec', 'ee', 'eg', 'er', 'es', 'et', 'eu', 'fi', 'fj', 'fk', 'fm',
                                         'fo', 'fr', 'ga', 'gb', 'gd', 'ge', 'gf', 'gg', 'gh', 'gi', 'gl',
                                         'gm', 'gn', 'gp', 'gq', 'gr', 'gt', 'gu', 'gw', 'gy', 'hk', 'hn',
                                         'hr', 'ht', 'hu', 'id', 'ie', 'il', 'im', 'in', 'io', 'iq', 'ir',
                                         'is', 'it', 'je', 'jm', 'jo', 'jp', 'ke', 'kg', 'kh', 'ki', 'km',
                                         'kn', 'kp', 'kr', 'kw', 'ky', 'kz', 'la', 'lb', 'lc', 'li', 'lk',
                                         'lr', 'ls', 'lt', 'lu', 'lv', 'ly', 'ma', 'mc', 'md', 'me', 'mf',
                                         'mg', 'mh', 'mk', 'ml', 'mm', 'mn', 'mo', 'mp', 'mq', 'mr', 'ms',
                                         'mt', 'mu', 'mv', 'mw', 'mx', 'my', 'mz', 'na', 'nc', 'ne', 'nf',
                                         'ng', 'ni', 'nl', 'no', 'np', 'nr', 'nu', 'nz', 'om', 'pa', 'pe',
                                         'pf', 'pg', 'ph', 'pk', 'pl', 'pm', 'pn', 'pr', 'ps', 'pt', 'pw',
                                         'py', 'qa', 're', 'ro', 'rs', 'ru', 'rw', 'sa', 'sb', 'sc', 'sd',
                                         'se', 'sg', 'sh', 'si', 'sk', 'sl', 'sm', 'sn', 'so', 'sr', 'ss',
                                         'st', 'sv', 'sx', 'sy', 'sz', 'tc', 'td', 'tg', 'th', 'tj', 'tk',
                                         'tl', 'tm', 'tn', 'to', 'tr', 'tt', 'tv', 'tw', 'tz', 'ua', 'ug',
                                         'us', 'uy', 'uz', 'va', 'vc', 've', 'vg', 'vi', 'vn', 'vu', 'wf',
                                         'ws', 'xk', 'ye', 'yt', 'za', 'zm', 'zw']

                     //Create Dropdown With Countries
                     var dropdown = document.getElementById("country_picker");
                     for (i = 0; i < countries_w_data.length; i++) {
                         var country_code = countries_w_data[i];
                         var country_option = new Option(getCountryName(country_code), country_code);
                         dropdown.appendChild(country_option);
                     }
                 };
                 create_country_picker();

                 //onclick censor and spike events get google news & twitter feed
                 function getNews(date, anomaly_type, country) {
                     var date = parseDate(date);
                     ////console.log(country)
                     // Create Twitter Link
                     setTwitterLink(date, anomaly_type, country);
                     setGoogleLink(date, anomaly_type, country);
                     setDateTitle(date, anomaly_type, country);
                 }

                </script>

                <script>
                 function setDateTitle(date, anomaly_type, country_code) {
                     var dateStr = date.getFullYear() + "-" + (date.getMonth() + 1 ) + "-" + date.getDate();
                     var country = getCountryName(country_code);
                     var titleElem = document.getElementById('content_date');
                     titleElem.innerHTML = '';
                     var h = document.createElement('h3');
                     var titleText = document.createTextNode(country + " experienced a possible " + anomaly_type + " anomaly on " + dateStr);
                     h.appendChild(titleText);
                     titleElem.appendChild(h);
                     var para = document.createElement('p');
                     var helpText = document.createTextNode("click on the links below to explore the event using social media");
                     para.appendChild(helpText);
                     titleElem.appendChild(para);
                 }
                </script>
                <script>
                 function setTwitterLink(date, anomaly_type, country_code) {

                     //https://twitter.com/search?f=tweets&
                     // q=tor%20china%20censor%20
                     //OR%20block%20
                     //since%3A2015-11-01%20until%3A2015-11-05

                     var country = getCountryName(country_code);
                     ////console.log(country)
                     var base_link = "https://twitter.com/search?f=tweets";

                     var all = "&q=tor%20" + country + "%20" ;

                     var any = "";

                     // no %20 because all has an extra at the end
                     any = any + anomaly_type
                     for (i = 0; i < events[anomaly_type].length; i++) {
                         any = any + "%20OR%20" + events[anomaly_type][i]
                     }
                     var dateStr = "%20since%3A"
                     var dateStart = date.getFullYear() + "-" + (date.getMonth()) + "-" + date.getDate();
                     // getMonth +2 gives a one month time range
                     var dateEnd = date.getFullYear() + "-" + (date.getMonth() + 2) + "-" + date.getDate();
                     dateStr = dateStr + dateStart + "%20until%3A" + dateEnd;

                     var twitLink = base_link + all + any + dateStr;

                     var twitElem = document.getElementById('twit_link');
                     twitElem.innerHTML = '';

                     var a = document.createElement('a');
                     var linkText = document.createTextNode("Look for context on twitter...");
                     a.appendChild(linkText);
                     a.title = "my title text";
                     a.href = twitLink;
                     a.target = "newtab";
                     twitElem.appendChild(a);
                 }
                </script>

                <script>
                 function setGoogleLink(date, anomaly_type, country){
                     // https://www.google.com/search?

                     // q=%22tor%22+%22china%22+
                     // "q="tor"+"china"+"

                     // censorship+OR+blocking&
                     // tbs=cdr%3A1%2Ccd_min%3A2%2F8%2F2014%2Ccd_max%3A3%2F8%2F2014&tbm=nws
                     // tbs=cdr:1,cd_min:2/8/2014,cd_max:3/8/2014&tbm=nws
                     var baseURI = "https://www.google.com/search?"

                     var country = getCountryName(country);

                     var all = 'q="tor"+"'
                     all = all + country + '"+'

                     var any = "";
                     any = any + anomaly_type
                     for (i = 0; i < events[anomaly_type].length; i++) {
                         any = any + "+OR+" + events[anomaly_type][i]
                     };
                     any = encodeURIComponent(any);

                     var dateStr = "&tbs=cdr:1,cd_min%3A";
                     // getMonth gives the previous month (0-11)
                     var dateStart = encodeURIComponent((date.getMonth()) + "-" + date.getDate() + "-" + date.getFullYear());
                     // getMonth +2 gives a one month ahead of the identified month
                     var dateEnd = encodeURIComponent((date.getMonth() + 2) + "-" + date.getDate() + "-" + date.getFullYear());
                     dateStr = dateStr + dateStart + ",cd_max%3A" + dateEnd + "&tbm=nws";
                     queryStr = all + any + dateStr;
                     queryStr = queryStr;
                     gooLink = baseURI + queryStr


                     var gooElem = document.getElementById('goo_link');
                     gooElem.innerHTML = '';

                     var a = document.createElement('a');
                     var linkText = document.createTextNode("Look for news articles on Google...");
                     a.appendChild(linkText);
                     a.title = "Click here to see related news events from this date range on Google.";
                     a.href = gooLink;
                     a.target = "newtab";
                     gooElem.appendChild(a);
                 };
                </script>


                <script>
                 // D3 Javascript

                 var margin = {top: 20, right: 20, bottom: 200, left: 50},
                     margin_brush = {top: 500, right: 20, bottom: 30, left: 50},
                     width = 960 - margin.left - margin.right,
                     height = 600 - margin.top - margin.bottom,
                     height_brush = 600 - margin_brush.top - margin_brush.bottom;

                 var parseDate = d3.time.format("%Y-%m-%d").parse;

                 var x = d3.time.scale()
                           .range([0, width]);

                 var x_brush = d3.time.scale()
                                 .range([0, width]);

                 var y = d3.scale.linear()
                           .range([height, 0]);

                 var y_brush = d3.scale.linear()
                                 .range([height_brush, 0]);

                 var xAxis = d3.svg.axis()
                               .scale(x)
                               .orient("bottom");

                 var xAxis_brush = d3.svg.axis()
                                     .scale(x_brush)
                                     .orient("bottom");

                 var yAxis = d3.svg.axis()
                               .scale(y)
                               .orient("left");

                 var brush = d3.svg.brush()
                               .x(x_brush)
                               .on("brush", brushed);

                 var line = d3.svg.line()
                              .x(function(d) { return x(d.date);  })
                              .y(function(d) { return y(d.users); });

                 var line_brush = d3.svg.line()
                                    .x(function(d) { return x_brush(d.date);  })
                                    .y(function(d) { return y_brush(d.users); });

                 var area = d3.svg.area()
                              .x(function(d) { return x(d.date); })
                              .y0(function(d) { return y(d.min); })
                              .y1(function(d) { return y(d.max); });

                 var area_brush = d3.svg.area()
                                    .x(function(d) { return x_brush(d.date); })
                                    .y0(function(d) { return y_brush(d.min); })
                                    .y1(function(d) { return y_brush(d.max); });


                 var svg = d3.select("#viz_frame").append("svg")
                             .attr("width", width + margin.left + margin.right)
                             .attr("height", height + margin.top + margin.bottom);

                 svg.append("defs").append("clipPath")
                    .attr("id", "clip")
                    .append("rect")
                    .attr("width", width)
                    .attr("height", height);

                 function brushed() {
                     x.domain(brush.empty() ? x_brush.domain() : brush.extent());
                     focus.select(".area").attr("d", area);
                     focus.select(".line").attr("d", line);
                     focus.selectAll(".spike")
                          .attr("cx", function(d) { return x(d.date);  })
                          .attr("cy", function(d) { return y(d.users); });
                     focus.selectAll(".drop")
                          .attr("cx", function(d) { return x(d.date);  })
                          .attr("cy", function(d) { return y(d.users); });
                     focus.select(".x.axis").call(xAxis);
                 };

                 function type(d) {
                     d.date = parseDate(d.date);
                     d.price = +d.price;
                     return d;
                 };


                 d3.select('#country_picker')
                   .on('change', function() {
                       //console.log(d3.select(this).property('value'))
                       var country_code = d3.select(this).property('value');
                       //console.log(country_code)
                       update(country_code);
                   });

                 //Add new elements
                 var focus = svg.append("g")
                                .attr("class", "focus")
                                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                 // Add brush element
                 var context = svg.append("g")
                                  .attr("class", "context")
                                  .attr("transform", "translate(" + margin_brush.left + "," + margin_brush.top + ")");


                 function update(country_code) {

                     // Clear all existing content
                     focus.selectAll("*").remove();
                     context.selectAll("*").remove();
                     document.getElementById('goo_link').innerHTML = '';
                     document.getElementById('twit_link').innerHTML = '';
                     document.getElementById('content_date').innerHTML = '';

                     //Grab Data and Draw
                     d3.csv(("https://raw.githubusercontent.com/elationfoundation/tor_anomaly/data/data/" + country_code + ".tsv"), function(error, data) {
                         if (error) throw error;

                         data.forEach(function(d) {
                             d.raw_date = d.date;
                             d.date = parseDate(d.date);
                             d.users = Math.floor(d.actual_users);
                             d.min = Math.floor(d.min_user_range);
                             d.max = Math.floor(d.max_user_range);
                             //console.log(d.event_censor)
                             d.censored = +d.event_censor;
                             d.spiked = +d.event_spike;
                         });

                         //console.log("01");
                         var clip_buffer = 1.25
                         x.domain(d3.extent(data, function(d) { return d.date; }));
                         y.domain(d3.extent(data, function(d) { return (d.users * clip_buffer); }));
                         x_brush.domain(x.domain());
                         y_brush.domain(y.domain());

                         focus.append("g")
                              .attr("class", "x axis")
                              .attr("transform", "translate(0," + height + ")")
                              .call(xAxis);

                         //console.log("02");

                         focus.append("g")
                                  .attr("class", "y axis")
                                  .call(yAxis)
                                  .append("text")
                                  .attr("transform", "rotate(-90)")
                                  .attr("y", 6)
                                  .attr("dy", ".71em")
                                  .style("text-anchor", "end")
                                  .text("Users");

                         //console.log("03");

                         //Draw Min/Max area
                         focus.append("path")
                                  .datum(data)
                                  .attr("class", "area")
                                  .attr("d", area);

                         //Draw Actual Users Number Line
                         focus.append("path")
                              .datum(data)
                              .attr("class", "line")
                              .attr("d", line);

                         //Draw Clickable Spike/Censor Anomalies

                         var anomalies = svg.selectAll(".shapes")
                                            .data(data).enter();

                         //Spikes
                         focus.selectAll("spike")
                              .data(data.filter(function(d) { return d.spiked == 1}))
                              .enter().append("circle")
                              .attr("class", "spike")
                              .attr("raw_date", function(d) { return d.raw_date;  })
                              .attr("countryCode", function(d) { return d.country; })
                              .attr("r", 3.5)
                              .attr("cx", function(d) { return x(d.date);  })
                              .attr("cy", function(d) { return y(d.users); })
                              .on("click", function() {
                                  ////console.log("Clicked");
                                  getNews(this.getAttribute("raw_date"),
                                          "spike",
                                          this.getAttribute("countryCode"));
                              });;

                         //Drop (Censorship)
                         focus.selectAll("drop")
                              .data(data.filter(function(d) { return d.censored == 1}))
                              .enter().append("circle")
                              .attr("class", "drop")
                              .attr("date", function(d) { return d.raw_date;})
                              .attr("countryCode", function(d) { return d.country;})
                              .attr("r", 3.5)
                              .attr("cx", function(d) { return x(d.date);  })
                              .attr("cy", function(d) { return y(d.users); })
                              .on("click", function() {
                                  //console.log("Clicked");
                                  getNews(this.getAttribute("date"),
                                          "censor",
                                          this.getAttribute("countryCode"));
                              });

                         //Adding the Brush in

                         context.append("g")
                                .attr("class", "x axis")
                                .attr("transform", "translate(0," + height_brush + ")")
                                .call(xAxis);

                         //Draw Min/Max area
                         context.append("path")
                                .datum(data)
                                .attr("class", "area")
                                .attr("d", area_brush);

                         //Draw Actual Users Number Line
                         context.append("path")
                                .datum(data)
                                .attr("class", "line")
                                .attr("d", line_brush);

                         context.append("g")
                                .attr("class", "x brush")
                                .call(brush)
                                .selectAll("rect")
                                .attr("y", -6)
                                .attr("height", height_brush + 7);
                     })};

                 //Update once on Start Up
                 update(d3.select('#country_picker').property('value'));

                </script>
            </div>
            <div class="sub_section">
                This is a <a href="https://github.com/elationfoundation/tor_anomaly">rewrite</a> and <a href="https://metrics.torproject.org/userstats-relay-country.html">new interactive data-visualization</a> of the Tor projects <a href="https://research.torproject.org/techreports/detector-2011-09-09.pdf">anomaly-based censorship-detection system.</a> I took on this side-project after hearing that multiple statisticians had attempted to update the code, but had given up because the <a href="https://gitweb.torproject.org/metrics-web.git/tree/modules/clients/detector.py">existing code-base was complex and badly documented.</a> I focused on making the existing code cleaner and comprehensively documented. I used the high-performance data analysis library pandas in the rewrite which speed up the data analysis considerably and allowed me to integrate previously external “preparation” scripts written in R directly into the code.
            </div>
        </div>
    </body>
